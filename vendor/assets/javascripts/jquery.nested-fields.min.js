!function(e){"use strict";function t(t){for(var n=e(t);n.length>0;){var r=n.data("nested-fields.options");if(r)return r;n=n.parent()}return null}function n(e){e.add.bind("click.nested-fields",function(t){t.preventDefault(),o(null,e,t)})}function r(t,n){e(t.itemSelector,n).each(function(e,n){l(n,t)})}function i(t){var n=new RegExp(t.newItemIndex,"g"),r=(new Date).getTime(),i=t.itemTemplate.html();t.unescapeTemplate&&(i=u(i));var o=e(i.replace(n,r));return o.attr("data-new-record",!0),o.attr("data-record-id",r),l(o,t),o}function o(e,t,n){function r(){e&&e(o),a(t),t.container.append(o)}var o=i(t);return t.skipBefore?r():(t.beforeInsert(o,r),t.beforeInsert.length<=1&&r()),t.skipAfter||t.afterInsert(o,n),o}function a(e){s(e).remove()}function c(t,n){function r(){i.attr("data-new-record")?i.remove():(i.find("INPUT[name$='[_destroy]']").val("true"),i.hide()),d(n)}var i=e(t);return n.skipBefore?r():(n.beforeRemove(i,r),n.beforeRemove.length<=1&&r()),n.skipAfter||n.afterRemove(i),i}function d(e){if(0===f(e).length){var t=e.emptyTemplate.html();t&&(e.unescapeTemplate&&(t=u(t)),e.container.append(t))}}function l(t,n){var r=e(t).find(n.removeSelector),i=r.attr("data-confirm"),o=i?"confirm:complete":"click";r.bind(o+".nested-fields",function(e,r){return e.preventDefault(),(void 0===r||r===!0)&&c(t,n),!1})}function f(e){return e.container.find(e.itemSelector+":visible")}function s(e){return e.container.find(e.emptySelector)}function u(e){var t=document.createElement("div");return t.innerHTML=e,0===t.childNodes.length?"":jQuery.trim(t.childNodes[0].nodeValue)}function m(e){console&&console.log&&console.log(e)}var p={beforeInsert:function(e,t){t()},afterInsert:function(){},beforeRemove:function(e,t){t()},afterRemove:function(){},itemTemplateSelector:".item.template",emptyTemplateSelector:".empty.template",containerSelector:".items, .container",itemSelector:".item",emptySelector:".empty",addSelector:".add",removeSelector:".remove",newItemIndex:"new_nested_item",unescapeTemplate:!0},v={init:function(t){return this.each(function(){var i=e(this);return i.data("nested-fields.options")?(m("Nested fields already defined for this element. If you want to redefine options, destroy it and init again."),i):(t=e.extend({},p,t),t.itemTemplate=e(t.itemTemplateSelector,i),t.emptyTemplate=e(t.emptyTemplateSelector,i),t.container=e(t.containerSelector,i),t.add=e(t.addSelector,i),i.data("nested-fields.options",t),n(t),void r(t,i))})},insert:function(n,r){return r=e.extend({},t(this),r),o(n,r)},remove:function(n,r){return r=e.extend({},t(this),r),c(n,r)},removeAll:function(n){n=e.extend({},t(this),n),e(v.items.apply(this)).each(function(e,t){v.remove(t,n)})},items:function(){return f(t(this))},destroy:function(){e(this).removeData("nested-fields.options"),e("*",this).unbind(".nested-fields")}};e.fn.nestedFields=function(t){return v[t]?v[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.nestedFields"):v.init.apply(this,arguments)}}(jQuery);